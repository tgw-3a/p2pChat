<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>チャット</title>
    <meta charset="UTF-8">
</head>
<body>
<h2 th:text="'ようこそ、' + ${nickName} + ' さん！'">ようこそ！</h2>

<div id="chat-box" style="border:1px solid #ccc; height:200px; overflow:auto; margin-bottom:10px;"></div>
<h3>オンラインの友達</h3>
<ul>
    <li th:each="friend : ${friends}">
        <button th:text="${friend.nickName}" th:onclick="'connectTo(\\'' + friend.peerId + '\\')'"></button>
    </li>
</ul>
<form id="chat-form">
    <input type="text" id="chat-input" placeholder="メッセージを入力" style="width:80%;">
    <button type="submit">送信</button>
</form>

<script type="module" src="/js/libp2pv2.mjs"></script>
<script>
    const form = document.getElementById("chat-form");
    const input = document.getElementById("chat-input");
    const box = document.getElementById("chat-box");

    form.addEventListener("submit", function(e) {
        e.preventDefault();
        const message = input.value.trim();
        if (message !== "") {
            const p = document.createElement("p");
            p.textContent = "[あなた] " + message;
            box.appendChild(p);
            input.value = "";

            // 今後: libp2p.send(message) など
        }
    });
</script>
<script>
    function connectTo(peerId) {
        const p = document.createElement("p");
        p.textContent = "[接続] " + peerId + " に接続しました。";
        document.getElementById("chat-box").appendChild(p);

        // 今後: libp2p.connect(peerId)
        if (libp2p) {
            libp2p.dial(peerId).then(() => {
                console.log("接続成功:", peerId);
            }).catch(err => {
                console.error("接続失敗:", err);
            });
        }
    }
</script>
</body>
</html>